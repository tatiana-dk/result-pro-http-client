{"version":3,"sources":["../src/utils.js","../src/client.js"],"sourcesContent":["export class HttpError extends Error {\r\n  constructor(status, statusText, response, message = '') {\r\n    super(message || `HTTP ${status} ${statusText}`);\r\n    this.name = 'HttpError';\r\n    this.status = status;\r\n    this.statusText = statusText;\r\n    this.response = response;      // оригинальный Response объект\r\n    this.isAbort = false;\r\n    this.isTimeout = false;\r\n    this.isNetwork = false;\r\n  }\r\n}","import { HttpError } from \"./utils.js\";\r\n\r\nexport { HttpError };\r\n\r\nexport function createClient(config = {}) {\r\n  const {\r\n    baseURL = '',\r\n    headers: defaultHeaders = {},\r\n    timeout,\r\n    beforeRequest,\r\n    afterResponse\r\n  } = config;\r\n\r\n  // Вспомогательная функция: добавляет query-параметры к URL\r\n  function buildUrl(url, query = {}) {\r\n    if (!query || Object.keys(query).length === 0) return url;\r\n\r\n    const params = new URLSearchParams();\r\n    for (const [key, value] of Object.entries(query)) {\r\n      if (value !== undefined && value !== null) {\r\n        params.append(key, value);\r\n      }\r\n    }\r\n    const queryString = params.toString();\r\n    return queryString ? `${url}?${queryString}` : url;\r\n  }\r\n\r\n    // Вспомогательная функция для нормализации ошибок\r\n    function normalizeError(err, signal, timeoutId) {\r\n        if (err instanceof HttpError) {\r\n            return err;\r\n        }\r\n\r\n        if (err.name === 'AbortError') {\r\n            const error = new HttpError(0, 'Aborted', null, 'Request aborted');\r\n            error.isAbort = true;\r\n            error.isTimeout = !signal && !!timeoutId;\r\n            return error;\r\n        }\r\n\r\n        const error = new HttpError(0, 'Network Error', null, err.message || 'Network failure');\r\n        error.isNetwork = true;\r\n        return error;\r\n    }\r\n\r\n    async function request(options) {\r\n        // Копируем опции, чтобы не менять оригинал\r\n        let currentOptions = {\r\n            ...options\r\n        };\r\n\r\n        // Хук ДО запроса\r\n        if (beforeRequest) {\r\n            currentOptions = (await beforeRequest(currentOptions)) || currentOptions;\r\n        }\r\n\r\n        // Настройки повторов (по умолчанию — без повторов)\r\n        const retry = currentOptions.retry ?? {};\r\n        const maxAttempts = retry.maxAttempts ?? 1; // 1 = без повторов\r\n        const baseDelayMs = retry.baseDelayMs ?? 1000;\r\n        const maxDelayMs = retry.maxDelayMs ?? 10000;\r\n        const backoffFactor = retry.backoffFactor ?? 2;\r\n\r\n        // Определяем, стоит ли вообще включать механизм повторов\r\n        const shouldEnableRetry = maxAttempts > 1;\r\n\r\n        let attempt = 1;\r\n        let lastError;\r\n\r\n        while (true) {\r\n            // 1. Собираем URL + query\r\n            let fullUrl = currentOptions.url;\r\n            if (currentOptions.query) {\r\n                fullUrl = buildUrl(fullUrl, currentOptions.query);\r\n            }\r\n            if (!fullUrl.startsWith('http')) {\r\n                fullUrl = baseURL + (fullUrl.startsWith('/') ? '' : '/') + fullUrl;\r\n            }\r\n\r\n            // 2. Объединяем заголовки\r\n            const mergedHeaders = {\r\n                'Content-Type': 'application/json',\r\n                ...defaultHeaders,\r\n                ...currentOptions.headers,\r\n            };\r\n\r\n            // 3. Готовим тело\r\n            let body = undefined;\r\n            if (currentOptions.body !== undefined) {\r\n                if (mergedHeaders['Content-Type'] === 'application/json') {\r\n                    body = JSON.stringify(currentOptions.body);\r\n                } else {\r\n                    body = currentOptions.body;\r\n                }\r\n            }\r\n\r\n            // 4. Таймаут и сигнал отмены\r\n            const signal = currentOptions.signal;\r\n            const internalController = new AbortController();\r\n            const effectiveSignal = signal || internalController.signal;\r\n\r\n            let timeoutId;\r\n            const ms = currentOptions.timeout ?? timeout ?? 0;\r\n            if (ms > 0 && !signal) {\r\n                timeoutId = setTimeout(() => internalController.abort(), ms);\r\n            }\r\n\r\n            let response;\r\n\r\n            try {\r\n                response = await fetch(fullUrl, {\r\n                    method: currentOptions.method || 'GET',\r\n                    headers: mergedHeaders,\r\n                    body,\r\n                    signal: effectiveSignal,\r\n                });\r\n\r\n                // Хук ПОСЛЕ ответа\r\n                if (afterResponse) {\r\n                    const modified = await afterResponse(response, currentOptions);\r\n                    if (modified) response = modified;\r\n                }\r\n\r\n                if (!response.ok) {\r\n                    throw new HttpError(response.status, response.statusText, response);\r\n                }\r\n\r\n                const contentType = response.headers.get('content-type') || '';\r\n                if (contentType.includes('application/json')) {\r\n                    return await response.json();\r\n                }\r\n                return await response.text();\r\n            } catch (err) {\r\n                lastError = err;\r\n\r\n                if (afterResponse) {\r\n                    await afterResponse(null, currentOptions, err).catch(() => {});\r\n                }\r\n\r\n                // Нормализуем ошибку\r\n                const normalizedError = normalizeError(err, signal, timeoutId);\r\n\r\n                // Определяем, можно ли повторить запрос\r\n                const isRetryable =\r\n                    normalizedError.isTimeout ||\r\n                    normalizedError.isNetwork ||\r\n                    (normalizedError.status >= 500 && normalizedError.status < 600) ||\r\n                    normalizedError.status === 429;\r\n\r\n                const isLastAttempt = attempt >= maxAttempts;\r\n\r\n                if (!shouldEnableRetry || !isRetryable || isLastAttempt) {\r\n                    throw normalizedError;\r\n                }\r\n\r\n                // Задержка перед следующей попыткой\r\n                const delay = Math.min(\r\n                    baseDelayMs * Math.pow(backoffFactor, attempt - 1),\r\n                    maxDelayMs\r\n                );\r\n\r\n                await new Promise(resolve => setTimeout(resolve, delay));\r\n\r\n                attempt++;\r\n                // продолжаем цикл → новая попытка\r\n            } finally {\r\n                if (timeoutId) clearTimeout(timeoutId);\r\n            }\r\n        }\r\n    }\r\n\r\n  return {\r\n    request,\r\n\r\n    // Короткие методы — основные действия\r\n    get(url, options = {}) {\r\n      return request({ method: 'GET', url, ...options });\r\n    },\r\n\r\n    post(url, body, options = {}) {\r\n      return request({ method: 'POST', url, body, ...options });\r\n    },\r\n\r\n    put(url, body, options = {}) {\r\n      return request({ method: 'PUT', url, body, ...options });\r\n    },\r\n\r\n    patch(url, body, options = {}) {\r\n      return request({ method: 'PATCH', url, body, ...options });\r\n    },\r\n\r\n    del(url, options = {}) {  // delete — зарезервированное слово\r\n      return request({ method: 'DELETE', url, ...options });\r\n    },\r\n  };\r\n}"],"mappings":";AAAO,IAAM,YAAN,cAAwB,MAAM;AAAA,EACnC,YAAY,QAAQ,YAAY,UAAU,UAAU,IAAI;AACtD,UAAM,WAAW,QAAQ,MAAM,IAAI,UAAU,EAAE;AAC/C,SAAK,OAAO;AACZ,SAAK,SAAS;AACd,SAAK,aAAa;AAClB,SAAK,WAAW;AAChB,SAAK,UAAU;AACf,SAAK,YAAY;AACjB,SAAK,YAAY;AAAA,EACnB;AACF;;;ACPO,SAAS,aAAa,SAAS,CAAC,GAAG;AACxC,QAAM;AAAA,IACJ,UAAU;AAAA,IACV,SAAS,iBAAiB,CAAC;AAAA,IAC3B;AAAA,IACA;AAAA,IACA;AAAA,EACF,IAAI;AAGJ,WAAS,SAAS,KAAK,QAAQ,CAAC,GAAG;AACjC,QAAI,CAAC,SAAS,OAAO,KAAK,KAAK,EAAE,WAAW,EAAG,QAAO;AAEtD,UAAM,SAAS,IAAI,gBAAgB;AACnC,eAAW,CAAC,KAAK,KAAK,KAAK,OAAO,QAAQ,KAAK,GAAG;AAChD,UAAI,UAAU,UAAa,UAAU,MAAM;AACzC,eAAO,OAAO,KAAK,KAAK;AAAA,MAC1B;AAAA,IACF;AACA,UAAM,cAAc,OAAO,SAAS;AACpC,WAAO,cAAc,GAAG,GAAG,IAAI,WAAW,KAAK;AAAA,EACjD;AAGE,WAAS,eAAe,KAAK,QAAQ,WAAW;AAC5C,QAAI,eAAe,WAAW;AAC1B,aAAO;AAAA,IACX;AAEA,QAAI,IAAI,SAAS,cAAc;AAC3B,YAAMA,SAAQ,IAAI,UAAU,GAAG,WAAW,MAAM,iBAAiB;AACjE,MAAAA,OAAM,UAAU;AAChB,MAAAA,OAAM,YAAY,CAAC,UAAU,CAAC,CAAC;AAC/B,aAAOA;AAAA,IACX;AAEA,UAAM,QAAQ,IAAI,UAAU,GAAG,iBAAiB,MAAM,IAAI,WAAW,iBAAiB;AACtF,UAAM,YAAY;AAClB,WAAO;AAAA,EACX;AAEA,iBAAe,QAAQ,SAAS;AAE5B,QAAI,iBAAiB;AAAA,MACjB,GAAG;AAAA,IACP;AAGA,QAAI,eAAe;AACf,uBAAkB,MAAM,cAAc,cAAc,KAAM;AAAA,IAC9D;AAGA,UAAM,QAAQ,eAAe,SAAS,CAAC;AACvC,UAAM,cAAc,MAAM,eAAe;AACzC,UAAM,cAAc,MAAM,eAAe;AACzC,UAAM,aAAa,MAAM,cAAc;AACvC,UAAM,gBAAgB,MAAM,iBAAiB;AAG7C,UAAM,oBAAoB,cAAc;AAExC,QAAI,UAAU;AACd,QAAI;AAEJ,WAAO,MAAM;AAET,UAAI,UAAU,eAAe;AAC7B,UAAI,eAAe,OAAO;AACtB,kBAAU,SAAS,SAAS,eAAe,KAAK;AAAA,MACpD;AACA,UAAI,CAAC,QAAQ,WAAW,MAAM,GAAG;AAC7B,kBAAU,WAAW,QAAQ,WAAW,GAAG,IAAI,KAAK,OAAO;AAAA,MAC/D;AAGA,YAAM,gBAAgB;AAAA,QAClB,gBAAgB;AAAA,QAChB,GAAG;AAAA,QACH,GAAG,eAAe;AAAA,MACtB;AAGA,UAAI,OAAO;AACX,UAAI,eAAe,SAAS,QAAW;AACnC,YAAI,cAAc,cAAc,MAAM,oBAAoB;AACtD,iBAAO,KAAK,UAAU,eAAe,IAAI;AAAA,QAC7C,OAAO;AACH,iBAAO,eAAe;AAAA,QAC1B;AAAA,MACJ;AAGA,YAAM,SAAS,eAAe;AAC9B,YAAM,qBAAqB,IAAI,gBAAgB;AAC/C,YAAM,kBAAkB,UAAU,mBAAmB;AAErD,UAAI;AACJ,YAAM,KAAK,eAAe,WAAW,WAAW;AAChD,UAAI,KAAK,KAAK,CAAC,QAAQ;AACnB,oBAAY,WAAW,MAAM,mBAAmB,MAAM,GAAG,EAAE;AAAA,MAC/D;AAEA,UAAI;AAEJ,UAAI;AACA,mBAAW,MAAM,MAAM,SAAS;AAAA,UAC5B,QAAQ,eAAe,UAAU;AAAA,UACjC,SAAS;AAAA,UACT;AAAA,UACA,QAAQ;AAAA,QACZ,CAAC;AAGD,YAAI,eAAe;AACf,gBAAM,WAAW,MAAM,cAAc,UAAU,cAAc;AAC7D,cAAI,SAAU,YAAW;AAAA,QAC7B;AAEA,YAAI,CAAC,SAAS,IAAI;AACd,gBAAM,IAAI,UAAU,SAAS,QAAQ,SAAS,YAAY,QAAQ;AAAA,QACtE;AAEA,cAAM,cAAc,SAAS,QAAQ,IAAI,cAAc,KAAK;AAC5D,YAAI,YAAY,SAAS,kBAAkB,GAAG;AAC1C,iBAAO,MAAM,SAAS,KAAK;AAAA,QAC/B;AACA,eAAO,MAAM,SAAS,KAAK;AAAA,MAC/B,SAAS,KAAK;AACV,oBAAY;AAEZ,YAAI,eAAe;AACf,gBAAM,cAAc,MAAM,gBAAgB,GAAG,EAAE,MAAM,MAAM;AAAA,UAAC,CAAC;AAAA,QACjE;AAGA,cAAM,kBAAkB,eAAe,KAAK,QAAQ,SAAS;AAG7D,cAAM,cACF,gBAAgB,aAChB,gBAAgB,aACf,gBAAgB,UAAU,OAAO,gBAAgB,SAAS,OAC3D,gBAAgB,WAAW;AAE/B,cAAM,gBAAgB,WAAW;AAEjC,YAAI,CAAC,qBAAqB,CAAC,eAAe,eAAe;AACrD,gBAAM;AAAA,QACV;AAGA,cAAM,QAAQ,KAAK;AAAA,UACf,cAAc,KAAK,IAAI,eAAe,UAAU,CAAC;AAAA,UACjD;AAAA,QACJ;AAEA,cAAM,IAAI,QAAQ,aAAW,WAAW,SAAS,KAAK,CAAC;AAEvD;AAAA,MAEJ,UAAE;AACE,YAAI,UAAW,cAAa,SAAS;AAAA,MACzC;AAAA,IACJ;AAAA,EACJ;AAEF,SAAO;AAAA,IACL;AAAA;AAAA,IAGA,IAAI,KAAK,UAAU,CAAC,GAAG;AACrB,aAAO,QAAQ,EAAE,QAAQ,OAAO,KAAK,GAAG,QAAQ,CAAC;AAAA,IACnD;AAAA,IAEA,KAAK,KAAK,MAAM,UAAU,CAAC,GAAG;AAC5B,aAAO,QAAQ,EAAE,QAAQ,QAAQ,KAAK,MAAM,GAAG,QAAQ,CAAC;AAAA,IAC1D;AAAA,IAEA,IAAI,KAAK,MAAM,UAAU,CAAC,GAAG;AAC3B,aAAO,QAAQ,EAAE,QAAQ,OAAO,KAAK,MAAM,GAAG,QAAQ,CAAC;AAAA,IACzD;AAAA,IAEA,MAAM,KAAK,MAAM,UAAU,CAAC,GAAG;AAC7B,aAAO,QAAQ,EAAE,QAAQ,SAAS,KAAK,MAAM,GAAG,QAAQ,CAAC;AAAA,IAC3D;AAAA,IAEA,IAAI,KAAK,UAAU,CAAC,GAAG;AACrB,aAAO,QAAQ,EAAE,QAAQ,UAAU,KAAK,GAAG,QAAQ,CAAC;AAAA,IACtD;AAAA,EACF;AACF;","names":["error"]}